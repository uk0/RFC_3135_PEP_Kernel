# RFC 3135 PEP TCP Accelerator Configuration v2.0
# =============================================
# This file contains module parameters for pep_accelerator.ko
# Edit values and run: ./loadconfig.sh
#
# Format: PARAMETER=VALUE (no spaces around '=')

# === Basic Settings ===
# Enable/disable the PEP accelerator (1=enabled, 0=disabled)
enabled=1

# Maximum number of concurrent flows to track
max_flows=65536

# Flow timeout in milliseconds (default: 300000 = 5 minutes)
flow_timeout=100000

# === PMTU Discovery Settings (v62) ===
# Enable Path MTU Discovery (1=enabled, 0=disabled)
pmtu_enabled=1

# PMTU cache timeout in milliseconds (default: 600000 = 10 minutes)
pmtu_timeout_ms=600000

# Default PMTU size in bytes (used when no cached value exists)
pmtu_default=1500

# === Queue Settings ===
# LAN->WAN queue limits (bytes)
lan_wan_queue_min=65536
lan_wan_queue_max=134217728

# WAN->LAN queue limits (bytes)
wan_lan_queue_min=65536
wan_lan_queue_max=134217728

# === BDP-Aware Dynamic Queue Settings (NEW in v24) ===
# Enable BDP-aware dynamic queue sizing
# Queue capacity automatically scales based on bandwidth × RTT
queue_bdp_enabled=1

# Queue size multiplier (queue = BDP × multiplier)
# Higher values provide more buffer for burst tolerance
queue_bdp_multiplier=2

# Absolute maximum queue size in bytes (safety cap)
# Prevents excessive memory usage even with high BDP
# v90: 从 16MB 增加到 64MB，支持高 BDP 场景双队列加速
queue_max_absolute=67108864

# Fallback WAN RTT in milliseconds (NEW in v25)
# Used when measured RTT < 10ms (proxy scenario detected)
# For satellite/high-latency links, may need higher values (500+)
# v63.9: 调整为实际 RTT 250ms
wan_rtt_ms=250

# === RTO (Retransmission Timeout) Settings ===
# Minimum RTO in milliseconds
# CRITICAL: Must be >= RTT to avoid spurious retransmissions
# v63.9: 500ms 避免 250ms RTT 下的伪超时
rto_min=500

# Maximum RTO in milliseconds
rto_max=3000

# Initial RTO in milliseconds
# v63.9: 550ms，适应 250ms RTT 环境
rto_init=550

# WAN SYN fail-open 超时/窗口（ms）
# 用于防止握手失败导致长时间卡住
wan_syn_fail_open_ms=5000
wan_syn_max_retries=5
wan_syn_init_rto_ms=1000
wan_syn_max_rto_ms=32000

# === Congestion Control Settings ===
# Initial congestion window (segments)
# Higher values = faster ramp-up on high-BDP links
# 32 segments × 1460 bytes = ~46KB initial window
init_cwnd=32

# Congestion control tuning (percent)
# v63.9: 降低拥塞反应激进度，稳定网速
cc_cong_reduction_pct=15
cc_ber_reduction_pct=8
cc_rtt_inflation_pct=45
ecn_ce_reduction_pct=30
ecn_enabled=1

# Estimated bandwidth in Mbps (for BDP calculation)
# v63.9: 匹配实际下载带宽
bandwidth_mbps=200

# === Shaper / Policy ===
# Enable directional shaper
shaper_enabled=1

# WAN uplink/downlink bandwidth in kbps (0 = derive from bandwidth_mbps)
# v63.9: 设置实际带宽值
wan_kbps=40000
wan_in_kbps=200000

# Shaper burst tuning
# v63.9: 减小突发，平滑流量
sm_burst_ms=8
sm_burst_min=16000
sm_burst_tolerance=16000

# Bypass new flows when overloaded
bypass_overflows=1

# Per-flow transmit cap (kbps, 0 = unlimited)
max_acc_flow_tx_kbps=0

# Limit acceleration to a LAN segment (0=disabled)
subnet_acc=1
lan_segment="10.211.55.0/24"

# === TCP Spoofing Mode ===
# Enable Split-TCP spoofing (1=enabled, 0=monitor only)
tcp_spoofing=1

# AppEx-style Advance ACK controls
# advacc: server-side advance ACK (download)
# advinacc: client-side fake ACK (upload)
advacc=1
advinacc=1

# Enable Fake ACK for immediate client acknowledgment
# WARNING: Enable only when local_retrans is also enabled
fake_ack=1

# Enable local retransmission queue management
local_retrans=1

# Local retrans cache limits
# v108: Increased for high-BDP links (32MB / 4096 pkts)
local_retrans_max_pkts=4096
local_retrans_max_bytes=33554432

# === Byte Cache ===
# Enable byte cache (memory + optional disk)
# v63.9: 禁用减少开销
byte_cache_enabled=0
byte_cache_mem_mb=250
byte_cache_disk_mb=0
byte_cache_disk_path="/tmp/"

# === Memory Tuning ===
mem_tune_enabled=1
mem_tune_low_mb=512
mem_tune_high_mb=2048
mem_tune_min_pct=50
mempool_max_cache_bytes=0

# === Offload Settings ===
# Enable GSO (Generic Segmentation Offload)
# v77: GSO 暂时禁用，待后续优化
gso_enabled=0

# Enable GRO (Generic Receive Offload)
# v79.1: GRO 在高并发负载下仍有间歇性问题，暂时禁用
# v78 修复了 PSH 标志处理，但压力测试显示仍有边缘情况
# 推荐: 保持禁用直到进一步优化
gro_enabled=0

# Enable RSC (Receive Segment Coalescing) for WAN->LAN
rsc_enabled=0
rsc_max_size=65536
rsc_timeout_us=2000

# Checksum offload/validation
tx_csum_enabled=1

rx_csum_enabled=1

# Fast Path optimization
fastpath_enabled=1
fastpath_threshold=10

# === Self-Learning Congestion Control ===
# Enable Q-Learning based congestion control
learning_enabled=1

# Exploration rate in percent (default=1)
# Lower values = more stable, higher values = more adaptation
# v64: Reduced from 5% to 1% for stability
learning_epsilon_pct=1

# === ACK Pacing Settings (NEW in v2.0) ===
# Enable ACK pacing for smoother data flow
# When enabled, Fake ACKs are sent at controlled intervals
# instead of immediately, reducing client burst sending
ack_pacing=1

# ACK delay in microseconds (0=auto)
# Smaller values = more frequent ACKs = lower latency but more overhead
# Larger values = less frequent ACKs = better batching but higher latency
ack_delay_us=0

# Bytes threshold to trigger immediate ACK
# When accumulated bytes exceed this, send ACK immediately
# regardless of delay timer
ack_bytes_threshold=0

# Pacing tuning (advanced)
# v63.9: 稍微降低激进度
pacing_gain_pct=110
pacing_min_interval_us=100
pacing_max_interval_us=10000
pacing_min_rate_pct=25

# === Re-seq Settings (NEW) ===
# Track out-of-order segments to avoid incorrect cumulative ACKs
# Useful on lossy/reordering links to prevent premature ACK advancement
reseq_enabled=1

# Maximum number of out-of-order segments to track per flow
reseq_max_packets=128

# === Scheduler / Classifier ===
# Enable global scheduler (priority-aware)
sched_enabled=1

# Small flow threshold in bytes (higher priority)
classify_small_flow_bytes=131072

# Engine scheduler (0=auto)
engine_num=0

# Scheduler delay in ms (0=no delay)
# v63.9: 移除人工延迟
task_sched_delay_wan_ms=0
task_sched_delay_lan_ms=0

# === RTT Probe ===
# Enable active RTT probe
rtt_probe_enabled=1

# Probe interval in milliseconds
rtt_probe_interval_ms=1000

# Only probe when idle for this many milliseconds
rtt_probe_idle_ms=500

# === IP Reassembly / Downlink Reorder / Split DL ===
# Enable IP fragment reassembly
ip_reassembly_enabled=1

# Enable split downlink acceleration (single-interface PEP key feature)
# Clone server data via netif_rx, filter client ACKs in POST_ROUTING
split_dl_enabled=1

# Enable downlink reordering
downlink_reorder_enabled=1

# Max downlink reorder packets to buffer
downlink_reorder_max=256

# Reorder timeout in milliseconds (flush if gap persists)
downlink_reorder_timeout_ms=200

# === Regional Learning Settings (NEW in v2.0) ===
# Enable per-destination learning for faster flow initialization
# New flows inherit optimal parameters from historical data
region_learning=1

# Maximum number of regions to track
# Each region represents a /prefix_len network
region_max=8192

# Region IP prefix length for aggregation
# /24 groups flows to same C-class network
# Smaller prefix = broader grouping = more flows per region
region_prefix=24

# === Debug Settings ===
# Debug level (0=off, 1=error, 2=warn, 3=info, 4=debug)
# v83.2: 生产环境使用 0 或 1，避免日志开销影响性能
debug_level=0

# === FEC (Forward Error Correction) Settings ===
# Enable FEC for high-loss links (satellite, wireless)
fec_enabled=1

# FEC parameters: K data packets + N-K parity packets
# Example: K=10, N=11 means 10% redundancy (1 parity per 10 data)
fec_k=10
fec_n=11

# === Interface Settings (optional) ===
# Specify WAN interface name (empty = auto-detect)
wan_if="enp0s5"

# Specify LAN interface name (empty = auto-detect)
lan_if="enp0s5"
